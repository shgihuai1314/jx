# 计划任务cron

## 概述
计划任务功能可以用来定时执行指定方法或php脚本，也可以用来定时执行系统命令（如定时创建文件夹、删除指定目录文件等）  

## 开启定时器
本系统的定时器是通过workman来实现的，在使用计划任务功能之前，需要先在控制台开启workman进程。
开启进程方法：
> 1. 打开控制台，cd到项目所在文件夹，如“D:/www/service-hall/”
> 2. 执行命令：php cron.php (linux服务器用 php cron.php start -d)  

windows控制台执行成功后如图：  
  
![workman](/docs/static/images/cron/workman.png)

进程开启后会每秒扫描数据库中的计划任务表(tab_cron)，找到需要执行的定时任务，当时间到达定时任务指定的执行时间是自动执行该任务。

## 后台配置
使用超级管理员账号登录后台，找到“系统->计划任务”菜单，添加要执行的任务并设置执行时间和周期。
  
![cron_task](/docs/static/images/cron/cron_task.png)

#### 1. 添加任务
打开“计划任务”菜单，点击“任务管理”，可以看到已经添加的任务。如果要添加新的任务，直接点击“添加任务”标签填写任务表单。
  
![cron_task_add](/docs/static/images/cron/cron_task_add.png)

> 任务的执行方式有三种  
>   1. **控制器方法**：需要在指定模块的console文件夹中配置控制台方法，具体案例请查看 **_schedule/console_**  
>   2. **控制台命令**：可以直接通过定时器执行控制台命令，如rm(删除文件), mkdir(创建文件夹)等。
并且可以在"{}"内加入php代码，执行前会自动解析，如date('YmdHis')会解析成当前日期时间
>   3. **php脚本**：定时器也可以直接执行php脚本，将写好的php脚本上传即可。
  
![cron_task_list](/docs/static/images/cron/cron_task_list.png)

#### 2. 设置定时任务
添加了任务之后还需要给任务配上定时器，一个任务可以配置多个定时器。  
可以直接在任务管理的列表中点击添加按钮给指定任务添加定时器，也可以在“定时器管理”菜单中添加定时器时手动选择任务。
  
![cron_add](/docs/static/images/cron/cron_add.png)

> 定时器的主要参数有 开始时间、间隔时间、状态
>   1. **开始时间**：脚本第一次开始执行的时间。
>   2. **间隔时间**：第一次执行之后在指定间隔时间后会重复执行。单位为：天、小时、分钟、秒。
>   3. **状态**：只有开启状态的任务才会被执行，定时器关闭后将不会再执行。  
  
![cron_list](/docs/static/images/cron/cron_list.png)

**_注：如果开始时间在当前时间之前，会根据间隔时间计算出下一次执行时间作为开始时间。
   例如：当前时间为2018-06-15 15:40:40，开始时间为 2018-06-15 00:00:00，间隔时间为1小时。则第一次执行时间为2018-06-15 16:00:00，以后每隔一小时执行一次。_**
   
## 结语
虽然windows和Linux系统本身也带有计划任务功能，但是配置起来相对复杂，而且不同的系统执行方式也不一样。为了方便统一管理，本系统采用workman的定时器功能来实现计划任务。
要使用定时器功能请务必记得在控制台开启workman的进程。在生产环境中要确保该进程正常执行。